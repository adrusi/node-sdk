{"version":3,"sources":["../src/PaginationStream.js"],"names":["reqr","global","GENTLY","hijack","require","stream","PaginationStream","_fetchPage","objectMode","_pageno","_items","_itemsRead","length","process","nextTick","push","pop","_nitems","err","count","items","emit","__range__","map","i","_read","Readable","module","exports","left","right","inclusive","range","ascending","end"],"mappings":";;;;;;;;;;AAAA,IAAMA,OAAoBC,OAAOC,MAAP,GAAgBA,OAAOC,MAAP,CAAcC,OAAd,CAAhB,GAAyCA,OAAnE;AACA;AACA,IAAMC,SAAoBL,KAAK,QAAL,CAA1B;;IAEMM,gB;;;AACJ,4BAAaC,UAAb,EAAyB;AAAA;;AAAA,oIACjB,EAACC,YAAY,IAAb,EADiB;;AAEvB,UAAKD,UAAL,GAAkBA,UAAlB;AACA,UAAKE,OAAL,GAAe,CAAf;AACA,UAAKC,MAAL,GAAc,EAAd;AACA,UAAKC,UAAL,GAAkB,CAAlB;AALuB;AAMxB;;;;4BAEQ;AAAA;;AACP,UAAI,KAAKD,MAAL,CAAYE,MAAZ,GAAqB,CAAzB,EAA4B;AAC1B,aAAKD,UAAL;AACA,eAAOE,QAAQC,QAAR,CAAiB;AAAA,iBAAM,OAAKC,IAAL,CAAU,OAAKL,MAAL,CAAYM,GAAZ,EAAV,CAAN;AAAA,SAAjB,CAAP;AACD;;AAED,UAAK,KAAKC,OAAL,IAAgB,IAAjB,IAA2B,KAAKN,UAAL,IAAmB,KAAKM,OAAvD,EAAiE;AAC/D,eAAOJ,QAAQC,QAAR,CAAiB;AAAA,iBAAM,OAAKC,IAAL,CAAU,IAAV,CAAN;AAAA,SAAjB,CAAP;AACD;;AAED,aAAO,KAAKR,UAAL,CAAgB,EAAE,KAAKE,OAAvB,EAAgC,UAACS,GAAD,QAAyB;AAAA,YAAlBC,KAAkB,QAAlBA,KAAkB;AAAA,YAAXC,KAAW,QAAXA,KAAW;;AAC9D,YAAIF,OAAO,IAAX,EAAiB;AACf,iBAAO,OAAKG,IAAL,CAAU,OAAV,EAAmBH,GAAnB,CAAP;AACD;;AAED,eAAKD,OAAL,GAAeE,KAAf;;AAEA,eAAKT,MAAL,GAAeY,UAAUF,MAAMR,MAAN,GAAe,CAAzB,EAA4B,CAA5B,EAA+B,IAA/B,EAAqCW,GAArC,CAAyC,UAACC,CAAD;AAAA,iBAAOJ,MAAMI,CAAN,CAAP;AAAA,SAAzC,CAAf;;AAEA,eAAO,OAAKC,KAAL,EAAP;AACD,OAVM,CAAP;AAYD;;;;EA/B4BpB,OAAOqB,Q;;AAkCtCC,OAAOC,OAAP,GAAiBtB,gBAAjB;;AAEA,SAASgB,SAAT,CAAoBO,IAApB,EAA0BC,KAA1B,EAAiCC,SAAjC,EAA4C;AAC1C,MAAIC,QAAQ,EAAZ;AACA,MAAIC,YAAYJ,OAAOC,KAAvB;AACA,MAAII,MAAM,CAACH,SAAD,GAAaD,KAAb,GAAqBG,YAAYH,QAAQ,CAApB,GAAwBA,QAAQ,CAA/D;AACA,OAAK,IAAIN,IAAIK,IAAb,EAAmBI,YAAYT,IAAIU,GAAhB,GAAsBV,IAAIU,GAA7C,EAAkDD,YAAYT,GAAZ,GAAkBA,GAApE,EAAyE;AACvEQ,UAAMjB,IAAN,CAAWS,CAAX;AACD;AACD,SAAOQ,KAAP;AACD","file":"PaginationStream.js","sourcesContent":["const reqr              = global.GENTLY ? GENTLY.hijack(require) : require\n// const TransloaditClient = reqr('./TransloaditClient')\nconst stream            = reqr('stream')\n\nclass PaginationStream extends stream.Readable {\n  constructor (_fetchPage) {\n    super({objectMode: true})\n    this._fetchPage = _fetchPage\n    this._pageno = 0\n    this._items = []\n    this._itemsRead = 0\n  }\n\n  _read () {\n    if (this._items.length > 0) {\n      this._itemsRead++\n      return process.nextTick(() => this.push(this._items.pop()))\n    }\n\n    if ((this._nitems != null) && (this._itemsRead >= this._nitems)) {\n      return process.nextTick(() => this.push(null))\n    }\n\n    return this._fetchPage(++this._pageno, (err, {count, items}) => {\n      if (err != null) {\n        return this.emit('error', err)\n      }\n\n      this._nitems = count\n\n      this._items = (__range__(items.length - 1, 0, true).map((i) => items[i]))\n\n      return this._read()\n    }\n    )\n  }\n}\n\nmodule.exports = PaginationStream\n\nfunction __range__ (left, right, inclusive) {\n  let range = []\n  let ascending = left < right\n  let end = !inclusive ? right : ascending ? right + 1 : right - 1\n  for (let i = left; ascending ? i < end : i > end; ascending ? i++ : i--) {\n    range.push(i)\n  }\n  return range\n}\n"]}